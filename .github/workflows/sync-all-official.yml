name: Sync All Official Repos

on:
  workflow_dispatch:
    inputs:
      repos:
        description: "要同步的仓库列表（逗号分隔，留空则同步所有）"
        required: false
        default: ""
  schedule:
    - cron: "0 0 1 * *"

jobs:
  fetch-repos:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
    steps:
      - name: Get all official repos
        id: get-repos
        run: |
          # 获取所有官方标准库（分 2 页获取）
          REPOS=()
          for page in 1 2; do
            REPOS+=($(curl -s "https://registry.hub.docker.com/v2/repositories/library/?page=$page&page_size=100" | jq -r '.results[].name'))
          done
          
          # 转换为 JSON 数组格式（使用 -c 紧凑输出）
          REPOS_JSON=$(printf '%s\n' "${REPOS[@]}" | jq -R . | jq -c -s .)
          
          echo "repos=${REPOS_JSON}" >> $GITHUB_OUTPUT
          echo "获取到的仓库数量: ${#REPOS[@]}"

  sync:
    needs: fetch-repos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.fetch-repos.outputs.repos) }}
      max-parallel: 2
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Sync ${{ matrix.repo }} tags
        run: |
          REPO="${{ matrix.repo }}"
          echo "开始同步 $REPO..."
          
          # 获取该仓库的所有标签（分页处理）
          page=1
          while true; do
            response=$(curl -s "https://registry.hub.docker.com/v2/repositories/library/$REPO/tags/?page=$page&page_size=100")
            tags=$(echo "$response" | jq -r '.results[].name')
            
            if [ -z "$tags" ]; then
              break
            fi
            
            total=$(echo "$tags" | wc -l)
            count=0
            
            for tag in $tags; do
              count=$((count + 1))
              echo "[$count/$total] 同步 $REPO:$tag..."
              
              if docker pull "docker.io/library/$REPO:$tag" 2>/dev/null; then
                docker tag "docker.io/library/$REPO:$tag" "ghcr.io/vansour/$REPO:$tag"
                docker push "ghcr.io/vansour/$REPO:$tag"
                docker rmi "docker.io/library/$REPO:$tag" "ghcr.io/vansour/$REPO:$tag"
              else
                echo "⚠ 无法拉取 $REPO:$tag"
              fi
              
              # 在请求之间添加延迟以避免触发速率限制
              sleep 1
            done
            
            page=$((page + 1))
            sleep 2
          done
          
          echo "✓ $REPO 同步完成"
