name: sync-docker

on:
  schedule:
    - cron: '0 0 1 * *'    # æ¯æœˆ1å·è¿è¡Œä¸€æ¬¡
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write      # å¿…é¡»æœ‰è¿™ä¸ªæƒé™æ‰èƒ½æ¨é€åˆ° GHCR

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Sync Images (Pull -> Tag -> Push)
        run: |
          # å®šä¹‰éœ€è¦åŒæ­¥çš„é•œåƒåˆ—è¡¨ (æ ¼å¼: é•œåƒå:æ ‡ç­¾)
          # å¯ä»¥æ ¹æ®éœ€è¦åœ¨è¿™é‡Œè½»æ¾æ·»åŠ æ›´å¤šé•œåƒ
          IMAGES=(
            "debian:trixie"
            "debian:trixie-slim"
            "rust:trixie"
            "node:trixie"
            "postgres:trixie"
            "openlistteam/openlist:latest-aio"
          )

          # ç›®æ ‡å‘½åç©ºé—´ (æ ¹æ®ä½ çš„é…ç½®æ˜¯ vansour)
          TARGET_NAMESPACE="vansour"

          for IMG in "${IMAGES[@]}"; do
            SRC_IMAGE="docker.io/library/${IMG}"
            TARGET_IMAGE="ghcr.io/${TARGET_NAMESPACE}/${IMG}"

            echo "----------------------------------------------------"
            echo "ğŸš€ Processing: $IMG"
            echo "   Source: $SRC_IMAGE"
            echo "   Target: $TARGET_IMAGE"

            # 1. Pull: å°è¯•æ‹‰å–æºé•œåƒ
            if docker pull "$SRC_IMAGE"; then
              
              # 2. Tag: é‡å‘½åé•œåƒ
              docker tag "$SRC_IMAGE" "$TARGET_IMAGE"
              
              # 3. Push: æ¨é€åˆ° GHCR
              docker push "$TARGET_IMAGE"
              
              echo "âœ… Successfully synced: $IMG"

              # 4. Cleanup: åˆ é™¤æœ¬åœ°é•œåƒä»¥èŠ‚çœ Runner ç£ç›˜ç©ºé—´
              docker rmi "$SRC_IMAGE" "$TARGET_IMAGE"
            else
              # å¦‚æœæºé•œåƒä¸å­˜åœ¨ï¼ˆä¾‹å¦‚ Trixie ç‰ˆæœ¬çš„ Postgres è¿˜æ²¡å‘å¸ƒï¼‰ï¼Œè„šæœ¬ä¸ä¼šä¸­æ–­ï¼Œè€Œæ˜¯æ‰“å°è­¦å‘Šå¹¶ç»§ç»­ä¸‹ä¸€ä¸ª
              echo "âš ï¸  Skipping $IMG: Source image not found or pull failed."
            fi
          done
