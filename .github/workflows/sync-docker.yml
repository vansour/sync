name: sync-docker

on:
  schedule:
    - cron: '0 0 1 * *'    # æ¯æœˆ1å·è¿è¡Œä¸€æ¬¡
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write      # å¿…é¡»æƒé™

    steps:
      - name: Sync Images with Skopeo
        run: |
          # -------------------------------------------------------
          # é…ç½®åŒºåŸŸ
          # -------------------------------------------------------
          # ç›®æ ‡å‘½åç©ºé—´
          TARGET_NS="vansour"
          
          # é•œåƒåˆ—è¡¨ (æ ¼å¼: æ¥æºé•œåƒå:æ ‡ç­¾)
          IMAGES=(
            "debian:trixie"
            "debian:trixie-slim"
            "rust:trixie"
            "node:trixie"
            "postgres:trixie"
            "openlistteam/openlist:latest-aio"
          )
          # -------------------------------------------------------

          echo "ğŸ”§ Installing Skopeo (if not present)..."
          # GitHub Actions Ubuntu Runner é€šå¸¸é¢„è£… Skopeoï¼Œä½†ä¸ºäº†ç¨³å¥æ€§æ£€æŸ¥ä¸€ä¸‹
          if ! command -v skopeo &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y skopeo
          fi

          echo "ğŸš€ Starting Sync Process..."

          for IMG in "${IMAGES[@]}"; do
            # 1. å‘½åå¤„ç†ï¼šå‰¥ç¦»ä¸Šæ¸¸ç»„ç»‡å
            # "openlistteam/openlist:latest-aio" -> "openlist:latest-aio"
            # "debian:trixie" -> "debian:trixie"
            FINAL_NAME=$(basename "$IMG")
            
            SRC_URL="docker://docker.io/$IMG"
            DEST_URL="docker://ghcr.io/$TARGET_NS/$FINAL_NAME"

            echo "----------------------------------------------------"
            echo "Processing: $IMG"
            echo "   Source: $SRC_URL"
            echo "   Target: $DEST_URL"

            # 2. æ‰§è¡ŒåŒæ­¥ (Skopeo Copy)
            # --all: å¤åˆ¶æ‰€æœ‰æ¶æ„ (amd64, arm64ç­‰)ï¼Œé¿å…é•œåƒè¢«â€œé˜‰å‰²â€
            # --src-no-creds: DockerHub å…¬å…±é•œåƒæ— éœ€å¯†ç 
            # --dest-creds: æ¨é€åˆ° GHCR éœ€è¦å‡­è¯
            
            if skopeo copy --all \
                --dest-creds "${{ github.actor }}:${{ secrets.GHCR_TOKEN }}" \
                "$SRC_URL" "$DEST_URL"; then
                echo "âœ… Success: $FINAL_NAME synced."
            else
                echo "âš ï¸  Failed: Could not sync $IMG. Check if tag exists."
            fi
          done
