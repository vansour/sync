name: sync-trixie

on:
  schedule:
    - cron: '0 0 1 * *'    # 每月1号运行一次
  workflow_dispatch:       # 允许手动点击触发

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write      # 必须有这个权限才能推送到 GHCR

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Prepare Sources File
        # 1. 预先生成新的源列表文件
        run: |
          cat <<EOF > debian.sources
          Types: deb
          URIs: https://mirrors.vansour.top/debian
          Suites: trixie trixie-updates trixie-backports
          Components: main contrib non-free non-free-firmware
          Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

          Types: deb-src
          URIs: https://mirrors.vansour.top/debian
          Suites: trixie trixie-updates trixie-backports
          Components: main contrib non-free non-free-firmware
          Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

          Types: deb
          URIs: https://mirrors.vansour.top/debian-security
          Suites: trixie-security
          Components: main contrib non-free non-free-firmware
          Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

          Types: deb-src
          URIs: https://mirrors.vansour.top/debian-security
          Suites: trixie-security
          Components: main contrib non-free non-free-firmware
          Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg
          EOF

      - name: Create Dockerfile
        # 2. 动态生成 Dockerfile
        # 修复警告的核心在于：ARG BASE_IMAGE=debian:trixie (给一个默认值)
        run: |
          cat <<EOF > Dockerfile
          # 给 ARG 设置默认值以消除 "InvalidDefaultArgInFrom" 警告
          ARG BASE_IMAGE=debian:trixie
          FROM \${BASE_IMAGE}

          # 步骤A: 确保 ca-certificates 已安装 (处理官方源)
          # 对于 Rust/Node 等基于 Debian 的镜像，这也适用
          RUN apt-get update && \
              apt-get install -y --no-install-recommends ca-certificates && \
              rm -rf /var/lib/apt/lists/*

          # 步骤B: 复制新源
          COPY debian.sources /etc/apt/sources.list.d/debian.sources

          # 步骤C: 清理旧源配置
          # 既删除 mirrors 目录，也清空旧的 sources.list
          RUN rm -rf /etc/apt/mirrors/ && \
              > /etc/apt/sources.list
          
          # 步骤D: 验证 (Build 时如果源有问题会在这里报错中止)
          RUN apt-get update
          EOF

      - name: Build and Push Images
        run: |
          # --- Debian ---
          echo "Processing Debian..."
          docker build --build-arg BASE_IMAGE=docker.io/library/debian:trixie \
            -t ghcr.io/vansour/debian:trixie .
          docker push ghcr.io/vansour/debian:trixie

          docker build --build-arg BASE_IMAGE=docker.io/library/debian:trixie-slim \
            -t ghcr.io/vansour/debian:trixie-slim .
          docker push ghcr.io/vansour/debian:trixie-slim

          # --- Rust ---
          echo "Processing Rust..."
          docker build --build-arg BASE_IMAGE=docker.io/library/rust:trixie \
            -t ghcr.io/vansour/rust:trixie . || echo "Skipping Rust (Source image not found?)"
          # 只有构建成功才推送
          docker image inspect ghcr.io/vansour/rust:trixie >/dev/null 2>&1 && docker push ghcr.io/vansour/rust:trixie || true

          # --- Node ---
          echo "Processing Node..."
          docker build --build-arg BASE_IMAGE=docker.io/library/node:trixie \
            -t ghcr.io/vansour/node:trixie . || echo "Skipping Node (Source image not found?)"
          docker image inspect ghcr.io/vansour/node:trixie >/dev/null 2>&1 && docker push ghcr.io/vansour/node:trixie || true

          # --- Postgres ---
          echo "Processing Postgres..."
          docker build --build-arg BASE_IMAGE=docker.io/library/postgres:trixie \
            -t ghcr.io/vansour/postgres:trixie . || echo "Skipping Postgres (Source image not found?)"
          docker image inspect ghcr.io/vansour/postgres:trixie >/dev/null 2>&1 && docker push ghcr.io/vansour/postgres:trixie || true
